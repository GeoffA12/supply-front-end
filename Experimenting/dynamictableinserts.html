<!doctype
          html>
<html
      lang="en">

<head>
    <meta
          charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible"
          content="ie=edge">


    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
            crossorigin="anonymous"></script>

    <!-- DataTables CDNs -->
    <link rel="stylesheet"
          type="text/css"
          href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">
    <script type="text/javascript"
            charset="utf8"
            src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.js"></script>
    <!-- <script type="text/javascript" src="//cdn.datatables.net/plug-ins/1.10.11/sorting/date-eu.js"></script> -->
    <script
            src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
    <script
            src="http://cdn.datatables.net/plug-ins/1.10.19/sorting/datetime-moment.js"></script>
    <script
            src="http://cdn.datatables.net/plug-ins/1.10.20/sorting/enum.js"></script>

    <!-- Bootstrap CDN -->
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
          crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>



    <!-- Site wide and page specific Styles -->
    <link rel="stylesheet"
          href="../styling/style.css"
          media="screen">
    <link rel="stylesheet"
          href="../styling/table.css"
          media="screen">
    <link rel="stylesheet"
          href="../styling/dashboard.css"
          media="screen">

    <title>
        WeGo
        Fleet
    </title>

    <script>
        $(document).ready(function () {
            $('table.index').DataTable();
        });
    </script>
</head>

<body>
    <!-- <p id='demoID'>Hi</p> -->
    <div
         id='tableBlock'>

    </div>
</body>
<script>
    json = {
        'VehicleID13': {
            'status': "active",
            'licenseplate': "AS1234",
            'fleetid': 1,
            'make': "Tesla",
            'model': "Model-T",
            'current_lat': 10.1,
            'current_lon': 10.1,
            'last_heartbeat': null,
        },
        'VehicleID14': {
            'status': "active",
            'licenseplate': "PO7319",
            'fleetid': 1,
            'make': "Tesla",
            'model': "Model-T",
            'current_lat': 20.2,
            'current_lon': 20.2,
            'last_heartbeat': null,
        }
    }
    arr = []
    Object.keys(json).forEach(function (key) {
        index = key.indexOf('D')
        vid = parseInt(key.substring(index + 1));
        inner = json[key];
        arr.push(
            [inner['fleetid'], vid, `${inner['make']}: ${inner['model']}`,
            `Lat: ${inner['current_lat']} Lon: ${inner['current_lon']}`,
            inner['status'], null, inner['licenseplate'], inner['last_heartbeat']
            ])
    });
    console.log(arr)

    fleets = {};
    arr.forEach(function (e) {
        key = e[0];
        if (!(key in fleets)) {
            fleets[e[0]] = [];
        }
        e.shift();
        fleets[key].push(e);
    });
    var tableDiv = document.getElementById('tableBlock');
    const numFleets = Object.keys(fleets).length;
    const colNames = ['Vehicle ID', 'Make', 'Location', 'Status', 'Date Added', 'Liscence Plate', 'Last Heartbeat'];
    const numCols = colNames.length;

    Object.keys(fleets).forEach(function (fleetNum) {
        var fleetData = fleets[fleetNum]
        const idHeader = `fleet${fleetNum}`;
        console.log(idHeader);
        console.log(fleetNum);

        let table = document.createElement('TABLE');
        table.setAttribute('id', `${idHeader}Table`);
        table.setAttribute('class', 'index table-bordered table-sm');
        table.setAttribute('min-width', '100%');

        let header = table.createTHead();
        header.insertRow(0);
        colNames.forEach(function (name) {
            let th = document.createElement('TH');
            let tr = table.tHead.children[0];
            th.innerHTML = name;
            tr.appendChild(th);
        });
        let tbody = document.createElement('TBODY');
        table.appendChild(tbody);
        fleetData.forEach(function (entry) {
            console.log(entry);
            var row = document.createElement('TR');
            entry.forEach(function (colVal, col, _) {
                var cell = document.createElement('TD');
                cell.appendChild(document.createTextNode(colVal));
                if (col == 0) {
                    cell.setAttribute('onclick', 'getDispatch(this)');
                    cell.setAttribute('data-toggle', 'modal');
                    cell.setAttribute('data-target', '#dispatchRecordPopup')
                }
                row.append(cell);
                // console.log(i, colVal);
            });
            tbody.appendChild(row);
        });
        let br = document.createElement('BR');

        /* Simple header for each table */
        let tableTitle = document.createElement('BUTTON');
        tableTitle.innerHTML = `Fleet #${fleetNum} Vehicle List`;
        tableTitle.setAttribute('type', 'button');
        tableTitle.setAttribute('class', 'collapseButton')
        tableTitle.setAttribute('data-toggle', 'collapse');
        tableTitle.setAttribute('data-target', `#${idHeader}collapse`);
        tableTitle.setAttribute('aria-expanded', 'false');
        tableTitle.setAttribute('aria-controls', `${idHeader}collapse`);

        /* 
            Now lets add those buttons that will allow our fleet manager to 'interact' with our database and
            actually manage his vehicles 
        */
        let buttonRow = document.createElement('DIV');
        buttonRow.setAttribute('id', `${idHeader}ButtonRow`);
        buttonRow.setAttribute('class', 'row');
        let verbs = ['Add', 'Remove', 'Update']
        verbs.forEach(function (verb) {
            let button = document.createElement('BUTTON');
            button.innerHTML = `${verb} Vehicle`;
            button.setAttribute('id', `${idHeader}${verb}Button`);
            verb = verb.toLowerCase();
            button.setAttribute('onclick', `${verb}Vehicle(this)`);
            button.setAttribute('class', 'smol')
            buttonRow.appendChild(button);
        });

        const actionRow = document.createElement('DIV');
        actionRow.setAttribute('id', `${idHeader}ActionRow`);
        actionRow.setAttribute('class', 'row');
        /* Making a row for consolidation. Might not need it, but if ever we actually want to disctinctly interact with the table blocks, now we can */
        let divRow = document.createElement('DIV');
        divRow.setAttribute('id', `${idHeader}Row`);
        divRow.setAttribute('class', 'justify-content-start card card-body');
        divRow.setAttribute('style', 'padding-top: 10px');
        divRow.setAttribute('object-fit', 'contain');

        divRow.appendChild(buttonRow);
        divRow.appendChild(actionRow);
        divRow.appendChild(table);

        const collapseRow = document.createElement('DIV');
        collapseRow.setAttribute('id', `${idHeader}collapse`);
        collapseRow.setAttribute('class', 'collapse');

        collapseRow.appendChild(divRow);

        /* Now we put everything together */
        tableDiv.appendChild(tableTitle);
        tableDiv.appendChild(collapseRow);
        tableDiv.appendChild(br);
    });
</script>

</html>